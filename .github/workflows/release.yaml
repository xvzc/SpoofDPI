name: Release

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Target Tag Name (e.g., v1.2.0)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  update-draft:
    # Run only on push to main to update the release draft
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    name: update-draft
    permissions:
      contents: write
      pull-requests: read
    runs-on: ubuntu-latest
    steps:
      - uses: release-drafter/release-drafter@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-publish:
    if: >-
      (github.event_name == 'release' && github.event.action == 'published') ||
      github.event_name == 'workflow_dispatch'
    name: build-and-publish
    runs-on: macos-latest
    steps:
      - name: Determine Tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "RELEASE_TAG=${{ inputs.tag_name }}" >> $GITHUB_ENV
          else
            echo "RELEASE_TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.RELEASE_TAG }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install Syft
        run: |
          curl -sSfL https://get.anchore.io/syft | sudo sh -s -- -b /usr/local/bin

      # v4.0.0
      - uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad

      # Run GoReleaser to build binaries, archives, packages, and SBOMs.
      - name: Build Artifacts
        # v6.4.0
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean --skip=publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ env.RELEASE_TAG }}

      # Upload all generated artifacts to the release.
      - name: Upload Artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ env.RELEASE_TAG }}"
          
          echo "Uploading artifacts to release: $TAG_NAME"
          
          gh release upload "$TAG_NAME" \
            dist/*.tar.gz \
            dist/*.json \
            dist/*.deb \
            dist/*.apk \
            dist/*.rpm \
            dist/*.zst \
            dist/checksums.txt \
            --clobber
